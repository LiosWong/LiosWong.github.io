---
title: 关于近两次生产问题思考
date: 2022-07-21 00:52:42
tags:
- 故障
- 复盘
categories:
- 生产问题  
---

复盘下最近两次生产问题，我也是全程参与并定位到问题，问题比较棘手复杂隐晦，难于发现。

### 更新缓存2022/6/8
* 背景
由于上午已经出了一个故障，下午在做预发与生产的数据隔离，所以隔离工作需要在当天完成，记得大概晚上9点多，计划回家了，一个同事在说数据有丢失的问题，通过接口查询确实有问题，通过定位代码也没发现，喊我过去帮忙一起排查。了解大概情况后，从代码入手，看调用链路代码是否有过改动，看了几遍没发现什么问题，
根据可能出问题的点，一层层看下去，在conver层，会把DO转化成DTO，DTO构造器里会把查出来的feature转换成map（另外一个同事新加逻辑）,由于初始化时feature还是空，所以会new出来一个空featureMap对象，该接口的逻辑是先查缓存，缓存为空，再查数据库再更新缓存，这样会导致缓存里featureMap是空的，进而影响业务。熬了一个通宵修复数据和刷新数据。
* 总结
更新缓存时，保证更新值的正确性


### 2022/7/6
* 背景  
同事在发布生产，监控告警出来频繁fgc，而且出现的时间和发布时间基本吻合，然后让发布的同事执行回滚，保证业务的进行。当时同事A 执行dump，分析出来只看到有超大的字节数组，并没有其他可用信息，同事A一直分析到晚上，但是还是一无所获得，吃完晚饭我也一起分析，确实无从下手，因为从dump里支配树上只能看到超大字节数组，里面的
对象也不是业务对象，从同事A反馈的信息是，应用启动的时候，此时老年代就被打满，出现fgc，给我的直觉不是业务代码导致的，应该是依赖导致，我从启动入手分析，根据支配树上超大的字节数组名称搜索tomcat启动日志可以直观的看到申请时看到new了一个和dump上一样大小的数组，而且有告警信息，接着日志下面有spring-boot-autoconfig的初始化bean的报错信息，由于
启动容器是阿里自研的tomcat，不会依赖spring-boot-autoconfig，这里有问题的，通过 ``mvn dependency:tree``分析应用的依赖树，找到spring-boot-autoconfig，排除应用中所有的即可。解决问题时已经到凌晨2点多。

* 总结
解决问题的思路需要转变，有时并不能根据dump直接发现问题，细节很重要，例如应用启动时触发fgc，说明大概不是业务代码导致，进而从其他方面入手，例如依赖，由于本次发布引入了一些依赖包，这些都很可疑，依赖的问题真的很头疼啊。